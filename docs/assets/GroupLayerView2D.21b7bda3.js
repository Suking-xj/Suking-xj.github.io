var e=Object.defineProperty,i=Object.defineProperties,r=Object.getOwnPropertyDescriptors,t=Object.getOwnPropertySymbols,s=Object.prototype.hasOwnProperty,a=Object.prototype.propertyIsEnumerable,l=(i,r,t)=>r in i?e(i,r,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[r]=t;import{D as n,E as d,dS as o,F as h,cm as c,dm as y}from"./vendor.d5722712.js";import{d as p,l as f}from"./LayerView2D.707e4a8e.js";import{r as b}from"./FramebufferObject.3fdde870.js";import{o as g}from"./WGLContainer.0961633f.js";import"./Container.88a25d8e.js";import"./mat4f32.a5cabe00.js";import"./_commonjsHelpers.f2a458db.js";import"./Utils.7d3ca496.js";import"./definitions.6737c10c.js";import"./VertexArrayObject.da7eca21.js";import"./vec4f32.6de15d07.js";import"./ShaderCompiler.18e59261.js";import"./earcut.0e5467f0.js";import"./GeometryUtils.9c8423f5.js";import"./MaterialKey.0738772f.js";let u=class extends p{constructor(e){super(e),this.layerViews=new c}initialize(){this.handles.add([this.layerViews.on("change",(e=>this._layerViewsChangeHandler(e))),this.layerViews.on("after-changes",(()=>this._layerViewsAfterChangesHandler())),this.layer.watch("visibilityMode",(()=>this._visibilityModeHandler()),!0),this.watch("visible",(()=>this._visibleHandler()),!0)],"grouplayerview"),this._layerViewsChangeHandler({target:null,added:this.layerViews.toArray(),removed:[],moved:[]}),this._layerViewsAfterChangesHandler()}set layerViews(e){this._set("layerViews",y(e,this._get("layerViews")))}isUpdating(){return this.layerViews.some((e=>e.updating))}_hasLayerViewVisibleOverrides(){return this.layerViews.some((e=>e._isOverridden("visible")))}_findLayerViewForLayer(e){return e&&this.layerViews.find((i=>i.layer===e))}_firstVisibleOnLayerOrder(){const e=this.layer.layers.find((e=>{const i=this._findLayerViewForLayer(e);return i&&i.visible}));return e&&this._findLayerViewForLayer(e)}_enforceExclusiveVisibility(e){this._hasLayerViewVisibleOverrides()&&(e||!(e=this._firstVisibleOnLayerOrder())&&this.layerViews.length>0&&(e=this._findLayerViewForLayer(this.layer.layers.getItemAt(0))),this.layerViews.forEach((i=>{i.visible=i===e})))}_layerViewsChangeHandler(e){this.handles.remove("grouplayerview:visible"),this.handles.add(this.layerViews.map((e=>e.watch("visible",(i=>this._layerViewVisibleHandler(i,e)),!0))).toArray(),"grouplayerview:visible");const i=e.added[e.added.length-1];let r=null;i&&i.visible&&(r=i),this._enforceVisibility(r)}_layerViewsAfterChangesHandler(){this.handles.remove("grouplayerview:updating"),this.handles.add(this.layerViews.map((e=>e.watch("updating",(()=>this._updateUpdating()),!0))).toArray(),"grouplayerview:updating"),this._updateUpdating()}_enforceVisibility(e){if(this._hasLayerViewVisibleOverrides())switch(this.layer.visibilityMode){case"inherited":{const e=this.visible;this.layerViews.forEach((i=>{i.visible=e}));break}case"exclusive":this._enforceExclusiveVisibility(e)}}_visibilityModeHandler(){this._enforceVisibility()}_layerViewVisibleHandler(e,i){if(this._hasLayerViewVisibleOverrides())switch(this.layer.visibilityMode){case"inherited":e!==this.visible&&(i.visible=this.visible);break;case"exclusive":this._enforceExclusiveVisibility(e&&i)}}_visibleHandler(){var e;this._hasLayerViewVisibleOverrides()&&"inherited"===(null==(e=this.layer)?void 0:e.visibilityMode)&&this._enforceVisibility()}_updateUpdating(){this.notifyChange("updating")}};n([d({cast:o})],u.prototype,"layerViews",null),n([d()],u.prototype,"view",void 0),u=n([h("esri.views.layers.GroupLayerView")],u);var v=u;class w extends g{constructor(){super(...arguments),this._lastWidth=0,this._lastHeight=0,this.requiresDedicatedFBO=!1}dispose(){this._renderTarget&&(this._renderTarget.dispose(),this._renderTarget=null)}doRender(e){const i=this.createRenderParams(e),{context:r,painter:t,profiler:s}=i;this._prevFBO=r.getBoundFramebufferObject(),s.recordContainerStart(this.name);const a=this._getFbo(i),l=t.getRenderTarget();r.bindFramebuffer(a),t.setRenderTarget(a),r.setDepthWriteEnabled(!0),r.setColorMask(!0,!0,!0,!0),r.setClearColor(0,0,0,0),r.setClearDepth(1),r.clear(r.gl.COLOR_BUFFER_BIT|r.gl.DEPTH_BUFFER_BIT),r.setDepthWriteEnabled(!1);for(const n of this.children)n.beforeRender(e);for(const n of this.children)n.processRender(i);for(const n of this.children)n.afterRender(e);t.setRenderTarget(l),r.bindFramebuffer(this._prevFBO),t.beforeRenderLayer(i,this._clippingInfos?255:0,this.computedOpacity),r.setStencilTestEnabled(!1),r.setStencilWriteMask(0),t.blitTexture(r,a.colorTexture,9728),t.compositeLayer(i,this.computedOpacity),s.recordContainerEnd()}createRenderParams(e){return n=((e,i)=>{for(var r in i||(i={}))s.call(i,r)&&l(e,r,i[r]);if(t)for(var r of t(i))a.call(i,r)&&l(e,r,i[r]);return e})({},super.createRenderParams(e)),d={blendMode:this.blendMode,effects:this.computedEffects,globalOpacity:1},i(n,r(d));var n,d}_getFbo(e){const{context:i,painter:r}=e,{width:t,height:s}=i.getViewport();if(t!==this._lastWidth||s!==this._lastHeight)if(this._lastWidth=t,this._lastHeight=s,this._renderTarget)this._renderTarget.resize(t,s);else{const e={target:3553,pixelFormat:6408,dataType:5121,samplingMode:9728,wrapMode:33071,width:t,height:s},a={colorTarget:0,depthStencilTarget:3},l=r.getSharedStencilBuffer();this._renderTarget=new b(i,a,e,l)}return this._renderTarget}}let _=class extends(f(v)){constructor(){super(...arguments),this.container=new w}attach(){this._updateStageChildren(),this.handles.add(this.layerViews.on("after-changes",(()=>this._updateStageChildren())),"grouplayerview2d")}detach(){this.handles.remove("grouplayerview2d"),this.container.removeAllChildren()}hitTest(e,i){return null}update(e){}moveStart(){}viewChange(){}moveEnd(){}_updateStageChildren(){this.container.removeAllChildren(),this.layerViews.forEach(((e,i)=>this.container.addChildAt(e.container,i)))}};_=n([h("esri.views.2d.layers.GroupLayerView2D")],_);var m=_;export default m;
