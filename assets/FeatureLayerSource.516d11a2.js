var e=Object.defineProperty,t=Object.defineProperties,a=Object.getOwnPropertyDescriptors,r=Object.getOwnPropertySymbols,s=Object.prototype.hasOwnProperty,n=Object.prototype.propertyIsEnumerable,l=(t,a,r)=>a in t?e(t,a,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[a]=r,i=(e,t)=>{for(var a in t||(t={}))s.call(t,a)&&l(e,a,t[a]);if(r)for(var a of r(t))n.call(t,a)&&l(e,a,t[a]);return e},u=(e,r)=>t(e,a(r));import{ae as o,af as d,ag as c,d2 as h,a5 as y,ai as p,d3 as m,aj as b,d4 as g,cr as f,d5 as F,d6 as R,aa as I,d7 as q,a0 as _,d8 as w,c$ as O}from"./vendor.74d5941c.js";import{i as v}from"./clientSideDefaults.2ad4eec3.js";const A=new Set(["Feature Layer","Table"]);let S=class extends h{constructor(){super(...arguments),this.type="feature-layer"}load(e){const t=y(e)?e.signal:null;return this.addResolvingPromise(this._fetchService(t)),Promise.resolve(this)}get queryTask(){const{capabilities:{query:{supportsFormatPBF:e}},parsedUrl:t,dynamicDataSource:a,gdbVersion:r,spatialReference:s,fieldsIndex:n}=this.layer,l=p("featurelayer-pbf")&&e?"pbf":"json";return new m({url:t.path,format:l,fieldsIndex:n,dynamicDataSource:a,gdbVersion:r,sourceSpatialReference:s})}async addAttachment(e,t){await this.load();const a=e.attributes[this.layer.objectIdField],r=this.layer.parsedUrl.path+"/"+a+"/addAttachment",s=this._getLayerRequestOptions(),n=this._getFormDataForAttachment(t,s.query);try{const e=await b(r,{body:n});return this._createFeatureEditResult(e.data.addAttachmentResult)}catch(l){throw this._createAttachmentErrorResult(a,l)}}async updateAttachment(e,t,a){await this.load();const r=e.attributes[this.layer.objectIdField],s=this.layer.parsedUrl.path+"/"+r+"/updateAttachment",n=this._getLayerRequestOptions({query:{attachmentId:t}}),l=this._getFormDataForAttachment(a,n.query);try{const e=await b(s,{body:l});return this._createFeatureEditResult(e.data.updateAttachmentResult)}catch(i){throw this._createAttachmentErrorResult(r,i)}}async applyEdits(e,t){await this.load();const a=e.addFeatures.map(this._serializeFeature,this),r=e.updateFeatures.map(this._serializeFeature,this),s=this._getFeatureIds(e.deleteFeatures,null==t?void 0:t.globalIdUsed);g(a,r,this.layer.spatialReference);const n=[],l=[],i=[...e.deleteAttachments];for(const c of e.addAttachments)n.push(await this._serializeAttachment(c));for(const c of e.updateAttachments)l.push(await this._serializeAttachment(c));const u=n.length||l.length||i.length?{adds:n,updates:l,deletes:i}:null,o=this._getLayerRequestOptions({method:"post",query:{adds:a.length?JSON.stringify(a):null,updates:r.length?JSON.stringify(r):null,deletes:s.length?null!=t&&t.globalIdUsed?JSON.stringify(s):s.join(","):null,gdbVersion:(null==t?void 0:t.gdbVersion)||this.layer.gdbVersion,rollbackOnFailure:null==t?void 0:t.rollbackOnFailureEnabled,useGlobalIds:null==t?void 0:t.globalIdUsed,attachments:u&&JSON.stringify(u)}}),d=await b(this.layer.parsedUrl.path+"/applyEdits",o);return this._createEditsResult(d)}async deleteAttachments(e,t){await this.load();const a=e.attributes[this.layer.objectIdField],r=this.layer.parsedUrl.path+"/"+a+"/deleteAttachments";try{return(await b(r,this._getLayerRequestOptions({query:{attachmentIds:t.join(",")},method:"post"}))).data.deleteAttachmentResults.map(this._createFeatureEditResult)}catch(s){throw this._createAttachmentErrorResult(a,s)}}fetchRecomputedExtents(e={}){const t=e.signal;return this.load({signal:t}).then((async()=>{const t=this._getLayerRequestOptions(u(i({},e),{query:{returnUpdates:!0}})),{layerId:a,url:r}=this.layer,{data:s}=await b(`${r}/${a}`,t),{id:n,extent:l,fullExtent:o,timeExtent:d}=s,c=l||o;return{id:n,fullExtent:c&&f.fromJSON(c),timeExtent:d&&F.fromJSON({start:d[0],end:d[1]})}}))}async queryAttachments(e,t={}){const{parsedUrl:a}=this.layer,r=a.path;await this.load();const s=this._getLayerRequestOptions(t);if(!this.layer.get("capabilities.operations.supportsQueryAttachments")){const{objectIds:t}=e,a=[];for(const e of t){const t=r+"/"+e+"/attachments";a.push(b(t,s))}return Promise.all(a).then((e=>t.map(((t,a)=>({parentObjectId:t,attachmentInfos:e[a].data.attachmentInfos}))))).then((e=>R(e,r)))}return this.queryTask.executeAttachmentQuery(e,s)}async queryFeatures(e,t){return await this.load(),this.queryTask.execute(e,u(i({},t),{query:i(i({},this.layer.customParameters),null==t?void 0:t.query)}))}async queryFeaturesJSON(e,t){return await this.load(),this.queryTask.executeJSON(e,u(i({},t),{query:i(i({},this.layer.customParameters),null==t?void 0:t.query)}))}async queryObjectIds(e,t){return await this.load(),this.queryTask.executeForIds(e,u(i({},t),{query:i(i({},this.layer.customParameters),null==t?void 0:t.query)}))}async queryFeatureCount(e,t){return await this.load(),this.queryTask.executeForCount(e,u(i({},t),{query:i(i({},this.layer.customParameters),null==t?void 0:t.query)}))}async queryExtent(e,t){return await this.load(),this.queryTask.executeForExtent(e,u(i({},t),{query:i(i({},this.layer.customParameters),null==t?void 0:t.query)}))}async queryRelatedFeatures(e,t){return await this.load(),this.queryTask.executeRelationshipQuery(e,u(i({},t),{query:i(i({},this.layer.customParameters),null==t?void 0:t.query)}))}async queryRelatedFeaturesCount(e,t){return await this.load(),this.queryTask.executeRelationshipQueryForCount(e,u(i({},t),{query:i(i({},this.layer.customParameters),null==t?void 0:t.query)}))}async _fetchService(e){let t=this.layer.sourceJSON;if(!t){const{data:a}=await b(this.layer.parsedUrl.path,this._getLayerRequestOptions({query:p("featurelayer-advanced-symbols")?{returnAdvancedSymbols:!0}:{},signal:e}));t=a}this.sourceJSON=this._patchServiceJSON(t);const a=t.type;if(!A.has(a))throw new I("feature-layer-source:unsupported-type",`Source type "${a}" is not supported`)}_patchServiceJSON(e){var t;if("Table"!==e.type&&e.geometryType&&(null==e||null==(t=e.drawingInfo)||!t.renderer)&&!e.defaultSymbol){const t=v(e.geometryType).renderer;q("drawingInfo.renderer",t,e)}return e}_serializeFeature(e){const{geometry:t,attributes:a}=e;return _(t)?{attributes:a}:"mesh"===t.type||"extent"===t.type?null:{geometry:t.toJSON(),attributes:a}}async _serializeAttachment(e){const{feature:t,attachment:a}=e,{globalId:r,name:s,contentType:n,data:l,uploadId:i}=a,u={globalId:r,parentGlobalId:null,contentType:null,name:null,uploadId:null,data:null};if(t&&(u.parentGlobalId="attributes"in t?t.attributes&&t.attributes[this.layer.globalIdField]:t.globalId),i)u.uploadId=i;else if(l){const e=await async function(e){if("string"==typeof e)return O(e)||{data:e};return new Promise(((t,a)=>{const r=new FileReader;r.readAsDataURL(e),r.onload=()=>t(O(r.result)),r.onerror=e=>a(e)}))}(l);u.contentType=e.mediaType,u.data=e.data,l instanceof File&&(u.name=l.name)}return s&&(u.name=s),n&&(u.contentType=n),u}_getFeatureIds(e,t){const a=e[0];return a?this._canUseGlobalIds(t,e)?this._getGlobalIdsFromFeatureIdentifier(e):"objectId"in a?this._getObjectIdsFromFeatureIdentifier(e):this._getIdsFromFeatures(e):[]}_getIdsFromFeatures(e){const t=this.layer.objectIdField;return e.map((e=>e.attributes&&e.attributes[t]))}_canUseGlobalIds(e,t){return e&&"globalId"in t[0]}_getObjectIdsFromFeatureIdentifier(e){return e.map((e=>e.objectId))}_getGlobalIdsFromFeatureIdentifier(e){return e.map((e=>e.globalId))}_createEditsResult(e){const t=e.data,a=e.data&&e.data.attachments;return{addFeatureResults:t.addResults?t.addResults.map(this._createFeatureEditResult,this):[],updateFeatureResults:t.updateResults?t.updateResults.map(this._createFeatureEditResult,this):[],deleteFeatureResults:t.deleteResults?t.deleteResults.map(this._createFeatureEditResult,this):[],addAttachmentResults:a&&a.addResults?a.addResults.map(this._createFeatureEditResult,this):[],updateAttachmentResults:a&&a.updateResults?a.updateResults.map(this._createFeatureEditResult,this):[],deleteAttachmentResults:a&&a.deleteResults?a.deleteResults.map(this._createFeatureEditResult,this):[]}}_createFeatureEditResult(e){const t=!0===e.success?null:e.error||{code:void 0,description:void 0};return{objectId:e.objectId,globalId:e.globalId,error:t?new I("feature-layer-source:edit-failure",t.description,{code:t.code}):null}}_createAttachmentErrorResult(e,t){const a=t.details.messages&&t.details.messages[0]||t.message,r=t.details.httpStatus||t.details.messageCode;return{objectId:e,globalId:null,error:new I("feature-layer-source:attachment-failure",a,{code:r})}}_getFormDataForAttachment(e,t){const a=e instanceof FormData?e:e&&e.elements?new FormData(e):null;if(a)for(const r in t){const e=t[r];null!=e&&(a.set?a.set(r,e):a.append(r,e))}return a}_getLayerRequestOptions(e={}){const{parsedUrl:t,gdbVersion:a,dynamicDataSource:r}=this.layer;return u(i({},e),{query:w(i(i(u(i({gdbVersion:a,layer:r?JSON.stringify({source:r}):void 0},t.query),{f:"json"}),this.layer.customParameters),null==e?void 0:e.query)),responseType:"json"})}};o([d()],S.prototype,"type",void 0),o([d({constructOnly:!0})],S.prototype,"layer",void 0),o([d({readOnly:!0})],S.prototype,"queryTask",null),S=o([c("esri.layers.graphics.sources.FeatureLayerSource")],S);var j=S;export default j;
