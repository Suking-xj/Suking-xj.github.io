var e=Object.defineProperty,t=Object.defineProperties,n=Object.getOwnPropertyDescriptors,o=Object.getOwnPropertySymbols,r=Object.prototype.hasOwnProperty,s=Object.prototype.propertyIsEnumerable,i=(t,n,o)=>n in t?e(t,n,{enumerable:!0,configurable:!0,writable:!0,value:o}):t[n]=o,a=(e,t)=>{for(var n in t||(t={}))r.call(t,n)&&i(e,n,t[n]);if(o)for(var n of o(t))s.call(t,n)&&i(e,n,t[n]);return e};import{bP as c,eM as l,eN as f,ae as u,ca as g,eO as d,eP as p,eQ as h,af as m,eR as w,eS as v,eT as y,eU as A,eV as b,eW as I,eX as L}from"./vendor.d5722712.js";import{A as N,f as S,u as U,a as V,p as E,c as O,o as P,i as x,m as M,T as W,d as j,b as D,l as F,h as k,e as B,O as T,x as z,g as C,w as R,E as q,L as H,F as $,I as G,U as Q,j as X,V as _,M as J,S as K,k as Y,q as Z,v as ee,z as te,B as ne,C as oe,D as re,G as se,H as ie}from"./InterleavedLayout.3486c591.js";import"./vec4.22cd98e7.js";function ae(e,t,n,o){for(let r=0;r<o;r++)if(e[t+r]!==e[n+r])return!1;return!0}function ce(e,t,n,o,r){for(let s=0;s<r;s++)n[o+s]=e[t+s]}function le(e,t,n){let o=0;for(let r=0;r<n;r++)o=e[t+r]+o|0,o=o+(o<<11)+(o>>>2)|0;return o>>>0}let fe=null;const ue={divisor:0};function ge(e,t={}){t=a(a({},ue),t);const n=e.stride;return e.fieldNames.filter((t=>{const n=e.fields.get(t).optional;return!(n&&n.glPadding)})).map((o=>{const r=e.fields.get(o),s=r.constructor.ElementCount,i=function(e){const t=de[e];if(t)return t;throw new Error("BufferType not supported in WebGL")}(r.constructor.ElementType),a=r.offset,c=!(!r.optional||!r.optional.glNormalized);return{name:o,stride:n,count:s,type:i,offset:a,normalized:c,divisor:t.divisor}}))}const de={u8:5121,u16:5123,u32:5125,i8:5120,i16:5122,i32:5124,f32:5126},pe=N().vec3f("position").u16("componentIndex").u16("u16padding");ge(N().vec2u8("sideness"));const he=N().vec3f("position0").vec3f("position1").u16("componentIndex").u8("variantOffset",{glNormalized:!0}).u8("variantStroke").u8("variantExtension",{glNormalized:!0}).u8("u8padding",{glPadding:!0}).u16("u16padding",{glPadding:!0}),me=he.clone().vec3f("normal"),we=he.clone().vec3f("normalA").vec3f("normalB");class ve{updateSettings(e){this.settings=e,this.edgeHashFunction=e.reducedPrecision?Le:Ie}write(e,t,n){const o=this.edgeHashFunction(n);Ee.seed=o;const r=Ee.getIntRange(0,255),s=Ee.getIntRange(0,this.settings.variants-1),i=Ee.getFloat(),a=255*(.5*function(e,t){const n=e<0?-1:1;return Math.abs(e)**t*n}(-(1-Math.min(i/.7,1))+Math.max(0,i-.7)/(1-.7),1.2)+.5);e.position0.setVec(t,n.position0),e.position1.setVec(t,n.position1),e.componentIndex.set(t,n.componentIndex),e.variantOffset.set(t,r),e.variantStroke.set(t,s),e.variantExtension.set(t,a)}trim(e,t){return e.slice(0,t)}}const ye=new Float32Array(6),Ae=new Uint32Array(ye.buffer),be=new Uint32Array(1);function Ie(e){const t=ye;t[0]=e.position0[0],t[1]=e.position0[1],t[2]=e.position0[2],t[3]=e.position1[0],t[4]=e.position1[1],t[5]=e.position1[2],be[0]=5381;for(let n=0;n<Ae.length;n++)be[0]=31*be[0]+Ae[n];return be[0]}function Le(e){const t=ye;t[0]=Ne(e.position0[0]),t[1]=Ne(e.position0[1]),t[2]=Ne(e.position0[2]),t[3]=Ne(e.position1[0]),t[4]=Ne(e.position1[1]),t[5]=Ne(e.position1[2]),be[0]=5381;for(let n=0;n<Ae.length;n++)be[0]=31*be[0]+Ae[n];return be[0]}function Ne(e){return Math.round(1e4*e)/1e4}class Se{constructor(){this.commonWriter=new ve}updateSettings(e){this.commonWriter.updateSettings(e)}allocate(e){return me.createBuffer(e)}write(e,t,n){this.commonWriter.write(e,t,n),l(Ve,n.faceNormal0,n.faceNormal1),f(Ve,Ve),e.normal.setVec(t,Ve)}trim(e,t){return this.commonWriter.trim(e,t)}}Se.Layout=me,Se.glLayout=ge(me,{divisor:1});class Ue{constructor(){this.commonWriter=new ve}updateSettings(e){this.commonWriter.updateSettings(e)}allocate(e){return we.createBuffer(e)}write(e,t,n){this.commonWriter.write(e,t,n),e.normalA.setVec(t,n.faceNormal0),e.normalB.setVec(t,n.faceNormal1)}trim(e,t){return this.commonWriter.trim(e,t)}}Ue.Layout=we,Ue.glLayout=ge(we,{divisor:1});const Ve=u(),Ee=new g;function Oe(e,t){return t.push(e.buffer),{buffer:e.buffer,layout:Pe(e.layout)}}function Pe(e){const o=new Array;return e.fields.forEach(((e,r)=>{const s=(i=a({},e),c={constructor:Me(e.constructor)},t(i,n(c)));var i,c;o.push([r,s])})),{stride:e.stride,fields:o,fieldNames:e.fieldNames}}const xe=[S,U,V,E,O,P,x,M,W,j,D,F,k,B,T,z,C,R,q,H,$,G,Q,X,_,J,K,Y,Z,ee,te,ne,oe,re,se,ie];function Me(e){return`${e.ElementType}_${e.ElementCount}`}const We=new Map;function je(e,t,n){const o=t/3,r=new Uint32Array(n+1),s=new Uint32Array(n+1),i=(e,t)=>{e<t?r[e+1]++:s[t+1]++};for(let w=0;w<o;w++){const t=e[3*w],n=e[3*w+1],o=e[3*w+2];i(t,n),i(n,o),i(o,t)}let a=0,c=0;for(let w=0;w<n;w++){const e=r[w+1],t=s[w+1];r[w+1]=a,s[w+1]=c,a+=e,c+=t}const l=new Uint32Array(6*o),f=r[n],u=(e,t,n)=>{if(e<t){const o=r[e+1]++;l[2*o]=t,l[2*o+1]=n}else{const o=s[t+1]++;l[2*f+2*o]=e,l[2*f+2*o+1]=n}};for(let w=0;w<o;w++){const t=e[3*w],n=e[3*w+1],o=e[3*w+2];u(t,n,w),u(n,o,w),u(o,t,w)}const g=(e,t)=>{const n=2*e,o=t-e;for(let r=1;r<o;r++){const e=l[n+2*r],t=l[n+2*r+1];let o=r-1;for(;o>=0&&l[n+2*o]>e;o--)l[n+2*o+2]=l[n+2*o],l[n+2*o+3]=l[n+2*o+1];l[n+2*o+2]=e,l[n+2*o+3]=t}};for(let w=0;w<n;w++)g(r[w],r[w+1]),g(f+s[w],f+s[w+1]);const d=new Int32Array(3*o),p=(t,n)=>t===e[3*n]?0:t===e[3*n+1]?1:t===e[3*n+2]?2:-1,h=(e,t)=>{const n=p(e,t);d[3*t+n]=-1},m=(e,t,n,o)=>{const r=p(e,t);d[3*t+r]=o;const s=p(n,o);d[3*o+s]=t};for(let w=0;w<n;w++){let e=r[w];const t=r[w+1];let n=s[w];const o=s[w+1];for(;e<t&&n<o;){const t=l[2*e],o=l[2*f+2*n];t===o?(m(w,l[2*e+1],o,l[2*f+2*n+1]),e++,n++):t<o?(h(w,l[2*e+1]),e++):(h(o,l[2*f+2*n+1]),n++)}for(;e<t;)h(w,l[2*e+1]),e++;for(;n<o;)h(l[2*f+2*n],l[2*f+2*n+1]),n++}return d}xe.forEach((e=>We.set(Me(e),e)));const De=-1;function Fe(e,t,n,o=Re){const r=e.vertices.position,s=e.vertices.componentIndex,i=d(o.anglePlanar),a=d(o.angleSignificantEdge),c=Math.cos(a),l=Math.cos(i),u=ze.edge,g=u.position0,A=u.position1,b=u.faceNormal0,N=u.faceNormal1,S=function(e){const t=e.faces.length/3,n=e.vertices.position,o=e.faces,r=Ce.v0,s=Ce.v1,i=Ce.v2,a=new Float32Array(3*t);for(let c=0;c<t;c++){const e=o[3*c+0],t=o[3*c+1],l=o[3*c+2];n.getVec(e,r),n.getVec(t,s),n.getVec(l,i),I(s,s,r),I(i,i,r),y(r,s,i),f(r,r),a[3*c+0]=r[0],a[3*c+1]=r[1],a[3*c+2]=r[2]}return a}(e),U=function(e){const t=e.faces.length/3,n=e.faces,o=e.neighbors;let r=0;for(let a=0;a<t;a++){const e=o[3*a+0],t=o[3*a+1],s=o[3*a+2],i=n[3*a+0],c=n[3*a+1],l=n[3*a+2];r+=e===De||i<c?1:0,r+=t===De||c<l?1:0,r+=s===De||l<i?1:0}const s=new Int32Array(4*r);let i=0;for(let a=0;a<t;a++){const e=o[3*a+0],t=o[3*a+1],r=o[3*a+2],c=n[3*a+0],l=n[3*a+1],f=n[3*a+2];(e===De||c<l)&&(s[i++]=c,s[i++]=l,s[i++]=a,s[i++]=e),(t===De||l<f)&&(s[i++]=l,s[i++]=f,s[i++]=a,s[i++]=t),(r===De||f<c)&&(s[i++]=f,s[i++]=c,s[i++]=a,s[i++]=r)}return s}(e),V=U.length/4,E=t.allocate(V);let O=0;const P=V,x=n.allocate(P);let M=0,W=0,j=0;const D=p(0,V),F=new Float32Array(V);h(F,((e,t,n)=>{r.getVec(U[4*t+0],g),r.getVec(U[4*t+1],A),n[t]=L(g,A)})),D.sort(((e,t)=>F[t]-F[e]));const k=new Array,B=new Array;for(let f=0;f<V;f++){const e=D[f],o=F[e],a=U[4*e+0],d=U[4*e+1],p=U[4*e+2],h=U[4*e+3],y=h===De;if(r.getVec(a,g),r.getVec(d,A),y)m(b,S[3*p+0],S[3*p+1],S[3*p+2]),w(N,b),u.componentIndex=s.get(a),u.cosAngle=v(b,N);else{if(m(b,S[3*p+0],S[3*p+1],S[3*p+2]),m(N,S[3*h+0],S[3*h+1],S[3*h+2]),u.componentIndex=s.get(a),u.cosAngle=v(b,N),Be(u,l))continue;u.cosAngle<-.9999&&w(N,b)}W+=o,j++,y||ke(u,c)?(t.write(E,O++,u),k.push(o)):Te(u,i)&&(n.write(x,M++,u),B.push(o))}const T=new Float32Array(k.reverse()),z=new Float32Array(B.reverse());return{regular:{instancesData:t.trim(E,O),lodInfo:{lengths:T}},silhouette:{instancesData:n.trim(x,M),lodInfo:{lengths:z}},averageEdgeLength:W/j}}function ke(e,t){return e.cosAngle<t}function Be(e,t){return e.cosAngle>t}function Te(e,t){const n=A(e.cosAngle),o=ze.fwd,r=ze.ortho;return b(o,e.position1,e.position0),n*(v(y(r,e.faceNormal0,e.faceNormal1),o)>0?-1:1)>t}const ze={edge:{position0:u(),position1:u(),faceNormal0:u(),faceNormal1:u(),componentIndex:0,cosAngle:0},ortho:u(),fwd:u()},Ce={v0:u(),v1:u(),v2:u()},Re={anglePlanar:4,angleSignificantEdge:35};async function qe(e){const t=(r=e,{data:pe.createView(r.dataBuffer),indices:"Uint32Array"===r.indicesType?new Uint32Array(r.indicesBuffer):"Uint16Array"===r.indicesType?new Uint16Array(r.indicesBuffer):void 0,indicesLength:r.indicesLength,writerSettings:r.writerSettings,skipDeduplicate:r.skipDeduplicate}),n=He(t),o=[t.data.buffer];var r;return{result:$e(n,o),transferList:o}}function He(e){const t=function(e,t,n,o){if(t)return{faces:n,facesLength:o,neighbors:je(n,o,e.count),vertices:e};const r=function(e,t,n){var o;const r=e.byteLength/(4*t),s=new Uint32Array(e,0,r*t);let i=new Uint32Array(r);const a=null!=(o=null==n?void 0:n.minReduction)?o:0,l=(null==n?void 0:n.originalIndices)||null,f=l?l.length:0,u=(null==n?void 0:n.componentOffsets)||null;let g=0;if(u)for(let c=0;c<u.length-1;c++){const e=u[c+1]-u[c];e>g&&(g=e)}else g=r;const d=Math.floor(1.1*g)+1;(null==fe||fe.length<2*d)&&(fe=new Uint32Array(c(2*d)));for(let c=0;c<2*d;c++)fe[c]=0;let p=0;const h=!!u&&!!l,m=h?f:r,w=h?new Uint32Array(f):null,v=1.96;let y=0!==a?Math.ceil(7.84*v/(a*a)*a*(1-a)):m,A=1,b=u?u[1]:m;for(let c=0;c<m;c++){if(c===y){const e=1-p/c;if(e+v*Math.sqrt(e*(1-e)/c)<a)return null;y*=2}if(c===b){for(let e=0;e<2*d;e++)fe[e]=0;if(l)for(let e=u[A-1];e<u[A];e++)w[e]=i[l[e]];b=u[++A]}const e=h?l[c]:c,n=e*t,o=le(s,n,t);let r=o%d,f=p;for(;0!==fe[2*r+1];){if(fe[2*r]===o){const e=fe[2*r+1]-1;if(ae(s,n,e*t,t)){f=i[e];break}}r++,r>=d&&(r-=d)}f===p&&(fe[2*r]=o,fe[2*r+1]=e+1,p++),i[e]=f}if(0!==a&&1-p/r<a)return null;if(h){for(let e=u[A-1];e<w.length;e++)w[e]=i[l[e]];i=w}const I=new Uint32Array(t*p);p=0;for(let c=0;c<m;c++)i[c]===p&&(ce(s,(h?l[c]:c)*t,I,p*t,t),p++);if(l&&!h){const e=new Uint32Array(f);for(let t=0;t<e.length;t++)e[t]=i[l[t]];i=e}return{buffer:I.buffer,indices:i,uniqueCount:p}}(e.buffer,e.stride/4,{originalIndices:n,originalIndicesLength:o}),s=je(r.indices,o,r.uniqueCount);return{faces:r.indices,facesLength:r.indices.length,neighbors:s,vertices:pe.createView(r.buffer)}}(e.data,e.skipDeduplicate,e.indices,e.indicesLength);return Ge.updateSettings(e.writerSettings),Qe.updateSettings(e.writerSettings),Fe(t,Ge,Qe)}function $e(e,t){return t.push(e.regular.lodInfo.lengths.buffer),t.push(e.silhouette.lodInfo.lengths.buffer),{regular:{instancesData:Oe(e.regular.instancesData,t),lodInfo:{lengths:e.regular.lodInfo.lengths.buffer}},silhouette:{instancesData:Oe(e.silhouette.instancesData,t),lodInfo:{lengths:e.silhouette.lodInfo.lengths.buffer}},averageEdgeLength:e.averageEdgeLength}}const Ge=new Se,Qe=new Ue;export{He as work,qe as wrappedWork};
