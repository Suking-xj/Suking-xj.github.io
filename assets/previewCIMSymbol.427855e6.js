import{a9 as e,bi as t,aq as a,cf as i,aj as r,gL as s,gM as n,cO as o,gN as l,gO as h,bc as c,bd as m,gP as g,gQ as d,e8 as f}from"./vendor.74d5941c.js";import{k as u,T as y}from"./cimAnalyzer.0b895c7f.js";import{o as p}from"./Rasterizer.86fb2371.js";import"./CIMSymbolHelper.6546a069.js";class M{constructor(){}rasterizeText(e,t){this._textRasterizationCanvas||(this._textRasterizationCanvas=document.createElement("canvas"));const a=this._textRasterizationCanvas,i=a.getContext("2d");this.setFontProperties(i,t),this.parameters=t,this.textLines=e.split(/\r?\n/),this.lineHeight=this.computeLineHeight();const r=this.computeTextWidth(i,t),s=this.lineHeight*this.textLines.length;a.width=r,a.height=s,this.renderedLineHeight=Math.round(this.lineHeight*t.pixelRatio),this.renderedHaloSize=t.halo.size*t.pixelRatio,this.renderedWidth=r*t.pixelRatio,this.renderedHeight=s*t.pixelRatio,this.fillStyle=function(e){return`rgba(${e.slice(0,3).toString()},${e[3]})`}(t.color),this.haloStyle=function(e){return`rgb(${e.slice(0,3).toString()})`}(t.halo.color);const n=this.renderedLineHeight,o=this.renderedHaloSize;this.setFontProperties(i,t);const l=function(e,t){return"center"===e?.5*t:"right"===e?t:0}(i.textAlign,this.renderedWidth)+o,h=o;let c=0,m=0;o>0&&this.renderHalo(i,l,h,c,m,t),m+=h,c+=l;for(const f of this.textLines)i.globalCompositeOperation="destination-out",i.fillStyle="rgb(0, 0, 0)",i.fillText(f,c,m),i.globalCompositeOperation="source-over",i.fillStyle=this.fillStyle,i.fillText(f,c,m),m+=n;const g=i.getImageData(0,0,this.renderedWidth,this.renderedHeight),d=new Uint8Array(g.data);if(t.premultiplyColors){let e;for(let t=0;t<d.length;t+=4)e=d[t+3]/255,d[t]=d[t]*e,d[t+1]=d[t+1]*e,d[t+2]=d[t+2]*e}return{size:[this.renderedWidth,this.renderedHeight],image:new Uint32Array(d.buffer),sdf:!1,simplePattern:!1,anchorX:0,anchorY:0}}renderHalo(e,t,a,i,r,s){const n=this.renderedWidth,o=this.renderedHeight;this._haloRasterizationCanvas||(this._haloRasterizationCanvas=document.createElement("canvas")),this._haloRasterizationCanvas.width=n,this._haloRasterizationCanvas.height=o;const l=this._haloRasterizationCanvas,h=l.getContext("2d");h.clearRect(0,0,n,o),this.setFontProperties(h,s),h.fillStyle=this.haloStyle,h.strokeStyle=this.haloStyle;const c=this.renderedHaloSize<3;h.lineJoin=c?"miter":"round",c?this.renderHaloEmulated(h,t,a):this.renderHaloNative(h,t,a),e.globalAlpha=this.parameters.halo.color[3],e.drawImage(l,0,0,n,o,i,r,n,o),e.globalAlpha=1}renderHaloEmulated(e,t,a){const i=this.renderedLineHeight,r=this.renderedHaloSize;for(const s of this.textLines){for(const[i,n]of x)e.fillText(s,t+r*i,a+r*n);a+=i}}renderHaloNative(e,t,a){const i=this.renderedLineHeight,r=this.renderedHaloSize;for(const s of this.textLines){const n=2*r,o=5,l=.1;for(let i=0;i<o;i++){const r=1-(o-1)*l+i*l;e.lineWidth=r*n,e.strokeText(s,t,a)}a+=i}}setFontProperties(t,a){const i=a.font,r=`${i.style} ${i.weight} ${e(a.size*a.pixelRatio)}px ${i.family}, sans-serif`;let s;switch(t.font=r,t.textBaseline="top",a.horizontalAlignment){case"left":s="left";break;case"right":s="right";break;case"center":s="center";break;default:s="left"}t.textAlign=s}computeTextWidth(e,t){let a=0;for(const r of this.textLines)a=Math.max(a,e.measureText(r).width);const i=t.font;return("italic"===i.style||"oblique"===i.style||"string"==typeof i.weight&&("bold"===i.weight||"bolder"===i.weight)||"number"==typeof i.weight&&i.weight>600)&&(a+=.3*e.measureText("A").width),a+=2*this.parameters.halo.size,Math.round(a)}computeLineHeight(){const e=1.275*this.parameters.size;return Math.round(e+2*this.parameters.halo.size)}}const x=[];{const e=16;for(let t=0;t<360;t+=360/e)x.push([Math.cos(Math.PI*t/180),Math.sin(Math.PI*t/180)])}var C,z;(z=C||(C={})).Legend="legend",z.Preview="preview";const I=(t,a,i)=>{if(t&&t.targetSize){let r;if(i){const a=Math.max(i.frame.xmax-i.frame.xmin,i.frame.ymax-i.frame.ymin);r=t.targetSize/e(a)}else r=t.targetSize/a.referenceSize;return r}return t&&t.scaleFactor?t.scaleFactor:1},w={fill:{legend:{frame:{xmax:15,xmin:0,ymax:15,ymin:0},geometry:{rings:[[[0,15],[15,7.5],[15,0],[0,0],[0,15]]]},canvasPaths:{rings:[[[0,15],[0,0],[15,7.5],[15,15],[0,15]]]}},preview:{frame:{xmax:100,xmin:0,ymax:100,ymin:0},geometry:{rings:[[[0,100],[100,100],[100,0],[0,0],[0,100]]]},canvasPaths:{rings:[[[0,100],[0,0],[100,0],[100,100],[0,100]]]}}},stroke:{legend:{frame:{xmax:24,xmin:0,ymax:-2,ymin:2},geometry:{paths:[[[0,0],[12,0],[24,0]]]},canvasPaths:{paths:[[[0,2],[12,2],[24,2]]]}},preview:{frame:{xmax:100,xmin:0,ymax:-2,ymin:2},geometry:{paths:[[[0,0],[50,0],[100,0]]]},canvasPaths:{paths:[[[0,2],[50,2],[100,2]]]}}}};function b(e,t,a,i){let r,s;return"function"==typeof e.materialHash?(r=(0,e.materialHash)(t,a,i),s=y(e.cim,e.materialOverrides)):(r=e.materialHash,s=e.cim),{analyzedCIM:s,hash:r}}const P=new class{constructor(e,t){this._spatialReference=e,this._avoidSDF=t,this._resourceCache=new Map,this._rasterizer=new p,this._textRasterizer=new M,this._pictureMarkerCache=new Map}async rasterizeCIMSymbolAsync(e,a,i,r,s,n,o,l){r=r||(a?null!=a.centroid?"esriGeometryPolygon":t(a.geometry):null)||function(e){if(!(e&&e.data&&e.data.symbol))return null;switch(e.data.symbol.type){case"CIMPointSymbol":case"CIMTextSymbol":return"esriGeometryPoint";case"CIMLineSymbol":return"esriGeometryPolyline";case"CIMPolygonSymbol":return"esriGeometryPolygon";default:return null}}(e);const h=await this.analyzeCIMSymbol(e,a?function(e){return(e?Object.keys(e):[]).map((t=>({name:t,alias:t,type:"string"==typeof e[t]?"esriFieldTypeString":"esriFieldTypeDouble"})))}(a.attributes):null,i,r,l);return this.rasterizeCIMSymbol(h,a,r,s,n,o)}async analyzeCIMSymbol(e,t,r,s,n){const o=[],l=t?{geometryType:s,spatialReference:this._spatialReference,fields:t}:null;let h;await u(e.data,l,o,this._avoidSDF),a(n);for(const a of o)"CIMPictureMarker"!==a.cim.type&&"CIMPictureFill"!==a.cim.type&&"CIMPictureStroke"!==a.cim.type||(h||(h=[]),h.push(this.fetchPictureMarkerResource(a,n))),r&&"text"===a.type&&"string"==typeof a.text&&a.text.indexOf("[")>-1&&(a.text=i(r,a.text,a.cim.textCase));return h&&await Promise.all(h),o}async fetchPictureMarkerResource(e,t){const a=e.materialHash;if(!this._pictureMarkerCache.get(a)){const i=(await r(e.cim.url,{responseType:"image",signal:t&&t.signal})).data;this._pictureMarkerCache.set(a,i)}}rasterizeCIMSymbol(e,t,a,i,r,n){const o=[];for(const l of e){i&&"function"==typeof i.scaleFactor&&(i.scaleFactor=i.scaleFactor(t,r,n));const e=this._getRasterizedResource(l,t,a,i,r,n);if(!e)continue;let h=0,c=e.anchorX||0,m=e.anchorY||0,g=!1,d=0,f=0;if("esriGeometryPoint"===a){const e=I(i,l,null);if(d=s(l.offsetX,t,r,n)*e||0,f=s(l.offsetY,t,r,n)*e||0,"marker"===l.type)h=s(l.rotation,t,r,n)||0,g=!!l.rotateClockwise&&l.rotateClockwise;else if("text"===l.type){if(h=s(l.angle,t,r,n)||0,void 0!==l.horizontalAlignment)switch(l.horizontalAlignment){case"left":c=-.5;break;case"right":c=.5;break;default:c=0}if(void 0!==l.verticalAlignment)switch(l.verticalAlignment){case"top":m=.5;break;case"bottom":m=-.5;break;case"baseline":m=-.25;break;default:m=0}}}null!=e&&o.push({angle:h,rotateClockWise:g,anchorX:c,anchorY:m,offsetX:d,offsetY:f,rasterizedResource:e})}return this.getSymbolImage(o)}getSymbolImage(t){const a=document.createElement("canvas"),i=a.getContext("2d");let r=0,s=0,o=0,l=0;const h=[];for(let n=0;n<t.length;n++){const a=t[n],c=a.rasterizedResource;if(!c)continue;const m=c.size,g=a.offsetX,d=a.offsetY,f=a.anchorX,u=a.anchorY,y=a.rotateClockWise||!1;let p=a.angle,M=e(g)-m[0]*(.5+f),x=e(d)-m[1]*(.5+u),C=M+m[0],z=x+m[1];if(p){y&&(p=-p);const e=Math.sin(p*Math.PI/180),t=Math.cos(p*Math.PI/180),a=M*t-x*e,i=M*e+x*t,r=M*t-z*e,s=M*e+z*t,n=C*t-z*e,o=C*e+z*t,l=C*t-x*e,h=C*e+x*t;M=Math.min(a,r,n,l),x=Math.min(i,s,o,h),C=Math.max(a,r,n,l),z=Math.max(i,s,o,h)}r=M<r?M:r,s=x<s?x:s,o=C>o?C:o,l=z>l?z:l;const I=i.createImageData(c.size[0],c.size[1]);I.data.set(new Uint8ClampedArray(c.image.buffer));const w={offsetX:g,offsetY:d,rotateClockwise:y,angle:p,rasterizedImage:I,anchorX:f,anchorY:u};h.push(w)}a.width=o-r,a.height=l-s;const c=-r,m=l;for(let n=0;n<h.length;n++){const t=h[n],a=this._imageDataToCanvas(t.rasterizedImage),r=t.rasterizedImage.width,s=t.rasterizedImage.height,o=c-r*(.5+t.anchorX),l=m-s*(.5-t.anchorY);if(t.angle){const r=(360-t.angle)*Math.PI/180;i.save(),i.translate(e(t.offsetX),-e(t.offsetY)),i.translate(c,m),i.rotate(r),i.translate(-c,-m),i.drawImage(a,o,l),i.restore()}else i.drawImage(a,o+e(t.offsetX),l-e(t.offsetY))}const g=new n({x:c/a.width-.5,y:m/a.height-.5});return{imageData:0!==a.width&&0!==a.height?i.getImageData(0,0,a.width,a.height):i.createImageData(1,1),anchorPosition:g}}_imageDataToCanvas(e){this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas"));const t=this._imageDataCanvas,a=t.getContext("2d");return t.width=e.width,t.height=e.height,a.putImageData(e,0,0),t}_imageTo32Array(e,t,a){this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas"));const i=this._imageDataCanvas,r=i.getContext("2d");return i.width=t,i.height=a,r.drawImage(e,0,0,t,a),new Uint32Array(r.getImageData(0,0,t,a).data.buffer)}_getRasterizedResource(e,t,a,i,r,n){let h,c,m,g;if("esriGeometryPolyline"===a||"esriGeometryPolygon"===a){const l=i&&i.style?i.style:C.Legend,g="esriGeometryPolyline"===a?w.stroke[l]:w.fill[l];if("line"===e.type){if("CIMSolidStroke"!==e.cim.type){if("CIMPictureStroke"===e.cim.type){const a=s(e.width,t,r,n),{image:i,width:o,height:l}=this._getPictureResource(e,a);return this._rasterizePictureResource(e,i,o,l,g,a)}return null}({analyzedCIM:h,hash:m}=b(e,t,r,n)),c=this._embedCIMLayerInVectorMarker(h,g)}else if("marker"===e.type){if("CIMPictureMarker"===e.cim.type)return null;if("CIMVectorMarker"!==e.cim.type)return null;e.cim.offsetX=s(e.offsetX,t,r,n),e.cim.offsetY=s(e.offsetY,t,r,n),e.cim.rotation=s(e.rotation,t,r,n),e.cim.markerPlacement=e.markerPlacement,({analyzedCIM:h}=b(e,t,r,n)),m=o(JSON.stringify(h)).toString(),c=this._embedCIMLayerInVectorMarker(h,g)}else{if("text"===e.type)return null;if("fill"===e.type){if("CIMHatchFill"===e.cim.type||"CIMVectorMarker"===e.cim.type||"CIMPictureMarker"===e.cim.type||"CIMPictureFill"===e.cim.type){const a=e.cim.size||e.cim.height;let i,s,o;if("CIMPictureMarker"===e.cim.type||"CIMPictureFill"===e.cim.type)({image:i,width:s,height:o}=this._getPictureResource(e,a));else{({analyzedCIM:h,hash:m}=b(e,t,r,n));const a=this._rasterizer.rasterizeJSONResource(h,1,this._avoidSDF);i=a.image,s=a.size[0],o=a.size[1]}return this._rasterizePictureResource(e,i,s,o,g,null)}if("CIMSolidFill"!==e.cim.type)return null;({analyzedCIM:h,hash:m}=b(e,t,r,n)),c=this._embedCIMLayerInVectorMarker(h,g)}}}else{if("text"===e.type)return g=this._rasterizeTextResource(e,t,i,r,n),g;({analyzedCIM:h,hash:m}=b(e,t,r,n));const a=I(i,e,null);if("CIMPictureMarker"===e.cim.type){const i=s(e.size,t,r,n)*a,{image:o,width:l,height:h}=this._getPictureResource(e,i);return g={image:o,size:[l,h],sdf:!1,simplePattern:!1,anchorX:e.anchorPoint?e.anchorPoint.x:0,anchorY:e.anchorPoint?e.anchorPoint.y:0},g}l(h,a,{preserveOutlineWidth:!1}),c=h}m+=a,i&&(m+=JSON.stringify(i));const d=this._resourceCache;return d.has(m)?d.get(m):(g=this._rasterizer.rasterizeJSONResource(c,window.devicePixelRatio||1,this._avoidSDF),d.set(m,g),g)}_rasterizeTextResource(e,t,a,i,r){const n=I(a,e,null),o=s(e.text,t,i,r);if(!o||0===o.length)return null;const l=s(e.fontName,t,i,r),c=s(e.style,t,i,r),m=s(e.weight,t,i,r),g=s(e.decoration,t,i,r),d=s(e.size,t,i,r)*n,f=s(e.horizontalAlignment,t,i,r),u=s(e.verticalAlignment,t,i,r),y=h(s(e.color,t,i,r)),p=h(s(e.outlineColor,t,i,r)),M={color:y,size:d,horizontalAlignment:f,verticalAlignment:u,font:{family:l,style:c,weight:m,decoration:g},halo:{size:s(e.outlineSize,t,i,r)||0,color:p,style:c},pixelRatio:1,premultiplyColors:!this._avoidSDF};return this._textRasterizer.rasterizeText(o,M)}_rasterizePictureResource(t,a,i,r,s,n){const o=document.createElement("canvas"),l=o.getContext("2d");o.height=e(Math.max(Math.abs(s.frame.ymax-s.frame.ymin),n)),o.width=e(Math.abs(s.frame.xmax-s.frame.xmin));const h=l.createImageData(i,r);h.data.set(new Uint8ClampedArray(a.buffer));const g=this._imageDataToCanvas(h),d=l.createPattern(g,"repeat"),f=Math.cos((-t.cim.rotation||0)*Math.PI/180),u=Math.sin((-t.cim.rotation||0)*Math.PI/180);d.setTransform({m11:f,m12:u,m21:-u,m22:f,m41:e(t.cim.offsetX)||0,m42:e(t.cim.offsetY)||0});const y=s.canvasPaths;let p,M,x;c(y)?(p=y.rings,l.fillStyle=d,M=l.fill,x=["evenodd"]):m(y)&&(p=y.paths,l.strokeStyle=d,l.lineWidth=n,M=l.stroke,p[0][0][1]=o.height/2,p[0][1][1]=o.height/2),l.beginPath();for(const c of p){const t=c?c.length:0;if(t>1){let a=c[0];l.moveTo(e(a[0]),e(a[1]));for(let i=1;i<t;++i)a=c[i],l.lineTo(e(a[0]),e(a[1]));l.closePath()}}M.apply(l,x);const C=l.getImageData(0,0,o.width,o.height),z=new Uint8Array(C.data);return{size:[o.width,o.height],image:new Uint32Array(z.buffer),sdf:!1,simplePattern:!1,anchorX:0,anchorY:0}}_getPictureResource(t,a){const i=this._pictureMarkerCache.get(t.materialHash);if(!i)return null;const r=i.height/i.width,s=a?r>1?e(a):e(a)/r:i.width,n=a?r>1?e(a)*r:e(a):i.height;return{image:this._imageTo32Array(i,s,n),width:s,height:n}}_embedCIMLayerInVectorMarker(e,t){const a=c(t.geometry)?"CIMPolygonSymbol":"CIMLineSymbol";return{type:"CIMVectorMarker",frame:t.frame,markerGraphics:[{type:"CIMMarkerGraphic",geometry:t.geometry,symbol:{type:a,symbolLayers:[e]}}]}}}(null,!0);async function v(e,t={}){const{size:a,maxSize:i,node:r,opacity:s}=t,n=t.cimOptions||t,{feature:o,fieldMap:l,geometryType:h,style:c}=n,m=g(e),u=Math.min(null!=a?a:m,null!=i?i:f(120));u!==m&&(e=e.clone(),d(e,u,{preserveOutlineWidth:!0}));let y=3;e&&e.data&&e.data.symbol&&"CIMPointSymbol"!==e.data.symbol.type&&(y=1);const p=await P.rasterizeCIMSymbolAsync(e,o,l,h,{scaleFactor:y,style:c}),M=document.createElement("canvas");M.width=p.imageData.width,M.height=p.imageData.height,M.getContext("2d").putImageData(p.imageData,0,0);let x=M.width/y,C=M.height/y;if(null!=a&&(null==(null==t?void 0:t.scale)||(null==t?void 0:t.scale))){const e=x/C;x=e<=1?Math.ceil(u*e):u,C=e<=1?u:Math.ceil(u/e)}const z=new Image(x,C);return z.src=M.toDataURL(),null!=s&&(z.style.opacity=`${s}`),r&&r.appendChild(z),z}export{v as previewCIMSymbol};
